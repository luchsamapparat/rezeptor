apiVersion: apps/v1
kind: Deployment
metadata:
  name: rezeptor
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rezeptor
  template:
    metadata:
      labels:
        app: rezeptor
        telemetry.luchsamappar.at/logs: "true"
    spec:
      containers:
        - name: rezeptor
          image: ghcr.io/luchsamapparat/rezeptor:latest
          ports:
            - containerPort: 80
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: PORT
              value: "80"
            - name: LOG_LEVEL
              value: "trace"
            - name: OTEL_SERVICE_NAME
              value: rezeptor
            - name: OTEL_SERVICE_VERSION
              value: "1.0.0"
            - name: OTEL_TRACES_EXPORTER
              value: otlp
            - name: OTEL_EXPORTER_OTLP_PROTOCOL
              value: http/protobuf
            - name: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
              value: http://telemetry-alloy.telemetry.svc.cluster.local:4318/v1/traces
            - name: OTEL_METRICS_EXPORTER
              value: otlp
            - name: OTEL_EXPORTER_OTLP_METRICS_ENDPOINT
              value: http://telemetry-alloy.telemetry.svc.cluster.local:4318/v1/metrics
            - name: POSTGRES_HOSTNAME
              value: rezeptor-database
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_DATABASE
              value: rezeptor
            - name: POSTGRES_USER
              value: rezeptor
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: rezeptor
                  key: POSTGRES_PASSWORD
            - name: FILE_UPLOADS_PATH
              value: /data/uploads
            - name: RECIPE_EXTRACTION_SYSTEM_PROMPT
              value: |
                You are a text extraction assistant specialized in processing cookbook photos. 
                Your task is to extract structured recipe information from OCR-like text found in images of cookbook pages.

                Follow these rules:
                - Detect the recipe title. If it is written in ALL CAPS, convert it to normal capitalization (e.g., 'CHICKEN CURRY' â†’ 'Chicken Curry').
                - Extract the page number if present.
                - Extract the full text content of the recipe (ingredients + instructions). Preserve line breaks and formatting where possible.
                - If you cannot find a title or page number, return null for that field.
                - Always return the result as a JSON object with this exact structure:

                {
                  'title': string | null,
                  'pageNumber': number | null,
                  'content': string
                }
            - name: RECIPE_EXTRACTION_USER_PROMPT
              value: Here is a photo of a cookbook page. Please extract the recipe information and return it in the required JSON format.
            - name: AZURE_DOCUMENT_INTELLIGENCE_ENDPOINT
              value: https://rezeptor.cognitiveservices.azure.com/
            - name: AZURE_DOCUMENT_INTELLIGENCE_KEY
              valueFrom:
                secretKeyRef:
                  name: rezeptor
                  key: AZURE_DOCUMENT_INTELLIGENCE_KEY
            - name: AZURE_OPENAI_ENDPOINT
              value: https://rezeptor-extraction.cognitiveservices.azure.com/
            - name: AZURE_OPENAI_KEY
              valueFrom:
                secretKeyRef:
                  name: rezeptor
                  key: AZURE_OPENAI_KEY
            - name: AZURE_OPENAI_MODEL
              value: gpt-5-mini
            - name: AZURE_OPENAI_DEPLOYMENT
              value: gpt-5-mini
            - name: GOOGLE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: rezeptor
                  key: GOOGLE_API_KEY
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 200m
              memory: 256Mi
          volumeMounts:
            - mountPath: /data
              name: data
          # livenessProbe:
          #   httpGet:
          #     path: /healthz/live
          #     port: 80
          # readinessProbe:
          #   httpGet:
          #     path: /healthz/ready
          #     port: 80
        - name: oauth2-proxy
          image: quay.io/oauth2-proxy/oauth2-proxy
          args:
            - --provider=oidc
            - --oidc-issuer-url=https://keycloak.luchsamappar.at/realms/apps
            - --client-id=rezeptor
            - --email-domain=*
            - --upstream=http://127.0.0.1:80
            - --http-address=0.0.0.0:4180
            - --cookie-secure=true
            - --skip-provider-button
            - --set-xauthrequest
            - --pass-authorization-header=true
            - --pass-user-headers
          env:
            - name: OAUTH2_PROXY_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: oauth2-proxy
                  key: OAUTH2_PROXY_CLIENT_SECRET
            - name: OAUTH2_PROXY_COOKIE_SECRET
              valueFrom:
                secretKeyRef:
                  name: oauth2-proxy
                  key: OAUTH2_PROXY_COOKIE_SECRET
          ports:
            - containerPort: 4180
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 100m
              memory: 128Mi
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: rezeptor
